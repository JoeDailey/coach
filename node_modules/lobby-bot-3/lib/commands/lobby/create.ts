import { SlashSubcommand } from "discord-slash"
import { CommandInteraction, TextChannel } from "discord.js"
import { Lobby } from "../../lobbies"
import { build, parseTeams } from "./edit"

export default new SlashSubcommand(
  "create",
  "Create a new lobby in a new thread",
  handle,
  build,
);

async function handle(interaction: CommandInteraction) {
  await interaction.reply({content: `Creating thread...`, ephemeral: true});
  const channel = (interaction.channel.isThread())
    ? interaction.channel.parent as TextChannel
    : interaction.channel as TextChannel;

  const name = interaction.options.getString('name')
    ?? `${(interaction.member?.user ?? interaction.user).username}'s Lobby`;
  const thread = await channel.threads.create({
    name,
    autoArchiveDuration: 1440,
    reason: `Game lobby`,
  });
  const lobby = await Lobby.create(
    thread.id,
    name,
    interaction.options.getNumber('min') ?? 2,
    interaction.options.getNumber('max'),
    parseTeams(interaction.options.getString('teams')) ?? [],
  );
  await thread.members.add(interaction.user);
  await lobby.addPlayers(interaction.user);
  await thread.send(await lobby.print(thread));
}
